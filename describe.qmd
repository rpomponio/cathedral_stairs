---
title: "ECP Mountaineering School Archives"
author: "Ray Pomponio"
format:
  html:
    theme: journal
    toc: true
    embed-resources: true
    anchor-sections: true
execute:
  echo: false
  warning: false
---

```{r}
library(data.table)
reps <- fread(file.path("Data/MtnSchoolStairReps.csv"))
library(lme4)
```

Convert rep times to vertical pace in meters per hour (MPH):

```{r}
reps[, PaceMPH:=60 * 132 / TimeMins]
reps[, LogPace:=log(PaceMPH)]
hist(reps$PaceMPH)
```

Examine distribution of (log) climbing pace over seasons:

```{r}
boxplot(LogPace ~ EntryYear, data=reps)
```

Examine distribution of pack weights over seasons:

```{r}
boxplot(Weight ~ EntryYear, data=reps)
```

Relationship between pace, weight, week of season, and rep number:

```{r}
pairs(reps[, .(LogPace, Weight, Week, RepNum)], pch=16, cex=0.75)
```

Weight-adjusted pace, by season:

```{r}
fit.pace <- lm(LogPace ~ Weight, data=reps)
reps[, PredLogPace1:=as.numeric(predict(fit.pace, newdata=reps))]
reps[, DiffLogPace1:=LogPace - PredLogPace1]
boxplot(DiffLogPace1 ~ EntryYear, data=reps)
```

Adjusting for pack weight, fit curves to describe student-specific responses to rep number:

```{r}
students <- reps[, .(EntryYear=first(EntryYear), Reps=.N), by=StudentID]
for (sid in students$StudentID){
  fit.sid <- lm(DiffLogPace1 ~ RepNum + I(RepNum^2), data=reps[StudentID==sid])
  students[StudentID==sid, alpha:=coef(fit.sid)[1]]
  students[StudentID==sid, beta1:=coef(fit.sid)[2]]
  students[StudentID==sid, beta2:=coef(fit.sid)[3]]
}
```

Randomly select 10 students and plot curves:

```{r}
sample.sid <- sample(students$StudentID, size=10)
get_curve <- function(x, alpha, beta1, beta2) alpha + beta1 * x + beta2 * x^2
plot(
  1:10,
  get_curve(
    1:10,
    students[StudentID==sample.sid[1], alpha],
    students[StudentID==sample.sid[1], beta1],
    students[StudentID==sample.sid[1], beta2]),
  ylim=c(-1, 1), type="b", pch=1, cex=0.5,
  ylab="Predicted Pace", main="Student response curves")
for (sid in sample.sid[2:10]){
  lines(
    1:10,
    get_curve(1:10, students[StudentID==sid, alpha],
              students[StudentID==sid, beta1], students[StudentID==sid, beta2]))
}
```

Distribution of quadratic terms among students:

```{r}
hist(students$beta2)
```

# hierarchical models of student response curves

```{r}
fit.rdm.int <- lmer(
  LogPace ~ Weight + EntryYear + RepNum + I(RepNum^2) + (1|StudentID),
  data=reps,
  REML=FALSE)
summary(fit.rdm.int)
```

```{r}
plot(
  1:10,
  get_curve(
    1:10,
    coef(fit.rdm.int)$StudentID[1, 1],
    coef(fit.rdm.int)$StudentID[1, "RepNum"],
    coef(fit.rdm.int)$StudentID[1, "I(RepNum^2)"]),
  ylim=c(5.5, 7.5), type="b", pch=1, cex=0.5,
  ylab="Predicted Pace", main="Student response curves")
for (i in 2:10){
  lines(
    1:10,
    get_curve(1:10, coef(fit.rdm.int)$StudentID[i, 1],
              coef(fit.rdm.int)$StudentID[i, "RepNum"],
              coef(fit.rdm.int)$StudentID[i, "I(RepNum^2)"]))
}
```

```{r}
fit.rdm.slp2 <- lmer(
  LogPace ~ Weight + RepNum + I(RepNum^2) + (1|StudentID) + (1|EntryYear),
  data=reps,
  REML=FALSE)
summary(fit.rdm.slp2)
```

