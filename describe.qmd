---
title: "Heterogeneity in Students' Response to Alpine Training"
subtitle: "From the ECP Mountaineering School Archives"
author: "Ray Pomponio"
format:
  html:
    theme: journal
    toc: true
    embed-resources: true
    anchor-sections: true
execute:
  echo: false
  warning: false
fig-cap-location: top
---

```{r}
# load packages for analysis
library(data.table)
library(lme4)
library(ggplot2)
theme_set(theme_linedraw(base_size=12))
```

```{r}
# load dataset in "long" format
reps <- fread(file.path("Data/MtnSchoolStairReps.csv"))
```

## Introduction

I begin this inquiry by deriving an outcome for each repetition of the stairs -- instead of rep times, which are somewhat arbitrary given the size of the Cathedral of Learning, I derive a measure of climbing pace in vertical meters per hour:

```{r}
#| echo: true
reps[, MetersPerHour:=60 * 132 / TimeMins] ##assumes Cathy is 132m tall
```

Below is the empirical distribution of the outcome (climbing pace):

```{r}
#| label: fig-hist-outcome
#| fig-cap: "Distribution of climbing pace over all reps in 10 seasons"
ggplot(reps, aes(x=MetersPerHour)) +
  geom_histogram(binwidth=10) +
  ylab("Frequency")
```

The distribution in @fig-hist-outcome shows a central tendency near 500 meters per hour, but with substantial variability. For external context, a [2004 study](https://www.tandfonline.com/doi/full/10.1080/15438620490497332) of Austrian hikers found their typical climbing pace fell between 180 and 480 meters per hour.[^1] Compared to indoor conditions, which are highly controlled, the typical climbing pace in the mountains would be slower than the pace reflected in these training logs. Consider too that students do not record the amount of time they rested between repetitions on the stairs.

[^1]: The study mentioned was published in the Journal of Research in Sports Medicine and is titled, *Exercise Capacity for Mountaineering: How Much Is Necessary?*

The goal here is to describe sources of variability in climbing pace due to some of the measured variables in this dataset:

* Student-level heterogeneity
* Pack weight
* Day of the week
* Week of the season
* Footwear (running shoes, hiking boots, or mountianeering boots)

Of these variables, I'm most interested in describing student-level heterogeneity; this is the variability due to differences between students. It could be due to innate ability, body composition, or other unknown factors. To elucidate as much as we can, I will use data from 10 years of training logs, relying on statistical modeling to inform my understanding.

## Visualization

To begin illustrating student-level heterogeneity, I select five random students and two random workouts from each students' training logs.

```{r}
set.seed(1818)
rand.stud.idxs <- sample(unique(reps$StudentID), size=5, replace=F)
rand.workouts <- data.table()
for (stud.idx in rand.stud.idxs){
  tmp <- reps[StudentID==stud.idx, .N, by=.(StudentID, Date, Week)]
  rand.workout.idxs <- sample(1:nrow(tmp), size=2, replace=F)
  rand.workouts <- rbindlist(
    list(rand.workouts, tmp[rand.workout.idxs, ]))
}
rand.reps <- merge(rand.workouts, reps, by=c("StudentID", "Date", "Week"))
rand.reps[, WorkoutID:=paste0(StudentID, " (Wk ", Week, ")")]
```

Each vertical column of the figure below corresponds to a student, and each panel corresponds to a single workout:

```{r}
#| label: fig-scatter-select
#| fig-cap: "Climbing pace trends in ten randomly-selected workouts (5 students)"
ggplot(rand.reps, aes(x=RepNum, y=MetersPerHour)) +
  facet_wrap(~WorkoutID, nrow=2, ncol=5, dir="v") +
  geom_point(shape=1) +
  geom_smooth(aes(col=StudentID), method="lm", se=F, linewidth=0.5) +
  scale_x_continuous(breaks=c(1, 4, 7, 10), minor_breaks=1:12) +
  theme(panel.spacing=unit(0, "lines"), legend.position="none")
```

The plots in @fig-scatter-select illustrate several interesting characteristics. Across students, climbing paces tend to slow down during a workout, with some exceptions. Across workouts, an individual student tends to exhibit a similar response to training. That is, if she/he tends to slow down during the first workout, she/he also tends to slow down during the second workout. Two students (the rightmost in the figure) appeared to maintain a relatively constant climbing pace throughout their workouts.

These characteristics are noteworthy because they can be exploited when building a statistical model to evaluate the variability in climbing pace. For example, the fact that students may exhibit a pattern of response over multiple workouts means that it is appropriate to pool information at the student level to learn about inter-student heterogeneity, which is the goal of this work.

## Model Building

I begin with a relatively simple model of climbing pace that attributes *all* of the variability to student-level heterogeneity. There are two sources of heterogeneity within this model:

1. Students' baseline climbing pace
2. Students' adaptation during the workout

I leave out the technical details of the model specification for simplicity but you can think of these two effects as the "intercept" and "slope" for each student; the software I use for modeling includes extensive documentation online.[^2]

[^2]: Fitting Linear Mixed-Effects Models using lme4. <https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf>

```{r}
#| echo: true
#| output: false
# fit model of only student-level heterogeneity
fit.slh <- lmer(MetersPerHour ~ RepNum + (RepNum | StudentID), reps)
fit.slh
```

The interpretation of this model's first effect is that across all students, the average baseline pace is `r format(unname(fixef(fit.slh)[1]), digits=3)` meters per hour; that's the pace at which the "typical" student would begin climbing. However, students vary substantially in this characteristic, with a standard deviation of about `r format(sd(ranef(fit.slh)$StudentID[, 1]), digits=3)` meters per hour. In other words, we can expect about half of all students to have a baseline climbing pace between `r format(unname(quantile(fixef(fit.slh)[1] + ranef(fit.slh)$StudentID[, 1], 0.25)), digits=3)` and `r format(unname(quantile(fixef(fit.slh)[1] + ranef(fit.slh)$StudentID[, 1], 0.75)), digits=3)` meters per hour. It is important to note that this model did not account for pack weight or other possible sources of variability.

The interpretation of this model's second effect is that across all students, the average response to training reps is a decline of `r format(abs(unname(fixef(fit.slh)[2])), digits=3)` meters per hour (per rep). In rough terms that is about 1% of the average baseline pace; we can equivalently say that students slow down by about 1% of their original pace per rep, at a fixed rate. But of course students vary in this characteristics, too. We can expect about half of all students to exhibit a slow down between `r format(unname(abs(quantile(fixef(fit.slh)[2] + ranef(fit.slh)$StudentID[, 2], 0.75))), digits=3)` and `r format(unname(abs(quantile(fixef(fit.slh)[2] + ranef(fit.slh)$StudentID[, 2], 0.25))), digits=3)` meters per hour (per rep).

There is an additional source of variability here, which is embedded in the model specification. That is, the correlation between the two effects across students is positive. This means a student with a faster baseline pace is less-likely to slow down during their workout; the converse is true of students with slower baseline climbing paces.

Below I attempt to illustrate this latent relationship, with each dot representing a student:

```{r}
#| label: fig-scatter-ranef
#| fig-cap: "Relationship between student pace (baseline) and response to reps (change in pace per rep)"
dt.slh <- data.table(ranef(fit.slh)$StudentID, keep.rownames=TRUE)
dt.slh[, RepNum:=RepNum + fixef(fit.slh)[2]]
ggplot(dt.slh, aes(x=RepNum, y=`(Intercept)`)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Adaptation to training (mid-workout)", y="Baseline pace")
```

```{r}
outl.stud.idxs <- dt.slh[RepNum > 20, rn]
outl.workouts <- data.table()
for (stud.idx in outl.stud.idxs){
  tmp <- reps[StudentID==stud.idx, .N, by=.(StudentID, Date, Week)]
  outl.workout.idxs <- sample(1:nrow(tmp), size=5, replace=F)
  outl.workouts <- rbindlist(
    list(outl.workouts, tmp[outl.workout.idxs, ]))
}
outl.reps <- merge(outl.workouts, reps, by=c("StudentID", "Date", "Week"))
outl.reps[, WorkoutID:=paste0(StudentID, " (Wk ", Week, ")")]
```

Looking at @fig-scatter-ranef makes it clear that two students are extreme outliers. I was curious what their workouts looked like, so I plotted a sample of them below:

```{r}
#| label: fig-scatter-outliers
#| fig-cap: "Climbing pace trends in two outlier students"
ggplot(outl.reps, aes(x=RepNum, y=MetersPerHour)) +
  facet_wrap(~WorkoutID, nrow=2, ncol=5, dir="h") +
  geom_point(shape=1) +
  geom_smooth(aes(col=StudentID), method="lm", se=F, linewidth=0.5) +
  scale_x_continuous(breaks=c(1, 4, 7, 10), minor_breaks=1:12) +
  theme(panel.spacing=unit(0, "lines"), legend.position="none")
```

The plots in @fig-scatter-outliers confirm that the two students in question are indeed outliers; they both exhibit a tendency to accelerate in their climbing pace during a workout. This is in stark contrast to the general tendency to slow down in pace, or at lease maintain it during a workout, illustrated in @fig-scatter-ranef.

## Model Refinement

* [ ] Include additional "fixed" effects
* [ ] Consider robust estimation (due to outliers)
* [ ] Analyze student-level effects grouping by season (are there differences?)
